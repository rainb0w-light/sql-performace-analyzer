<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¡¨ç»¼åˆåˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        h1 {
            color: #333;
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #2196F3;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #2196F3;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: #2196F3;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #2196F3;
        }

        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 4px solid #2e7d32;
        }

        .result-section {
            margin-top: 30px;
        }

        .result-card {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-card .value {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .suggestions-list {
            list-style: none;
            padding: 0;
        }

        .suggestions-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
        }

        .markdown-content {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 20px;
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .markdown-content h3 {
            font-size: 1.25em;
        }

        .markdown-content h4 {
            font-size: 1em;
        }

        .markdown-content p {
            margin-bottom: 16px;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 16px;
            padding-left: 2em;
        }

        .markdown-content li {
            margin-bottom: 8px;
        }

        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: #f4f4f4;
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 16px;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #dfe2e5;
            padding-left: 16px;
            margin: 16px 0;
            color: #6a737d;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #dfe2e5;
            padding: 8px 12px;
        }

        .markdown-content table th {
            background: #f6f8fa;
            font-weight: 600;
        }

        .markdown-content a {
            color: #2196F3;
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-bottom: 15px;
        }

        .download-btn:hover {
            background: #1976D2;
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .query-list {
            display: grid;
            gap: 15px;
        }

        .query-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
        }

        .query-item.slow {
            border-left: 4px solid #f44336;
        }

        .query-item.fast {
            border-left: 4px solid #4CAF50;
        }

        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .query-header h4 {
            color: #333;
            font-size: 16px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-danger {
            background: #ffebee;
            color: #c62828;
        }

        .query-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .info-item {
            color: #666;
        }

        .info-item strong {
            color: #333;
        }

        .sql-code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .table-structure {
            margin-top: 20px;
        }

        .structure-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .structure-table th,
        .structure-table td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .structure-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .structure-table tr:nth-child(even) {
            background: #fafafa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>å•è¡¨ç»¼åˆåˆ†æå·¥å…·</h1>
                <div class="nav-links">
                    <a href="/index.html">SQLåˆ†æ</a>
                    <a href="/natural-language-analysis.html">è‡ªç„¶è¯­è¨€åˆ†æ</a>
                    <a href="/prompt-management.html">Promptç®¡ç†</a>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" @click="switchTab('upload')">ä¸Šä¼ MyBatis XML</button>
                <button class="tab" @click="switchTab('analyze')">è¡¨åˆ†æ</button>
                <button class="tab" @click="switchTab('parameters')">å‚æ•°ç®¡ç†</button>
                <button class="tab" @click="switchTab('statistic-values')">ç»Ÿè®¡å€¼ç®¡ç†</button>
            </div>

            <!-- ä¸Šä¼ MyBatis XMLæ ‡ç­¾é¡µ -->
            <div id="upload-tab" class="tab-content active">
                <div class="form-section">
                    <h2>ä¸Šä¼ MyBatis Mapper XMLæ–‡ä»¶</h2>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="mapper-namespace">Mapperå‘½åç©ºé—´ï¼š</label>
                        <input 
                            type="text" 
                            id="mapper-namespace"
                            v-model="mapperNamespace"
                            placeholder="ä¾‹å¦‚: com.example.mapper.UserMapper"
                            :disabled="uploading"
                        />
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="xml-content">XMLå†…å®¹ï¼š</label>
                        <textarea 
                            id="xml-content"
                            v-model="xmlContent"
                            placeholder="ç²˜è´´MyBatis Mapper XMLå†…å®¹..."
                            :disabled="uploading"
                        ></textarea>
                    </div>
                    <button 
                        class="btn-primary"
                        @click="uploadMapperXml"
                        :disabled="uploading || !mapperNamespace.trim() || !xmlContent.trim()"
                    >
                        {{ uploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ å¹¶è§£æ' }}
                    </button>

                    <div v-if="uploadError" class="error">
                        {{ uploadError }}
                    </div>

                    <div v-if="uploadSuccess" class="success">
                        {{ uploadSuccess }}
                    </div>
                </div>
            </div>

            <!-- è¡¨åˆ†ææ ‡ç­¾é¡µ -->
            <div id="analyze-tab" class="tab-content">
                <div class="form-section">
                    <h2>åˆ†ææŒ‡å®šè¡¨çš„æ‰€æœ‰æŸ¥è¯¢</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="table-name">è¡¨åï¼š</label>
                            <input 
                                type="text" 
                                id="table-name"
                                v-model="tableName"
                                placeholder="ä¾‹å¦‚: users"
                                :disabled="analyzing"
                            />
                        </div>
                        <div class="form-group">
                            <label for="analyze-datasource">æ•°æ®æºï¼š</label>
                            <select 
                                id="analyze-datasource"
                                v-model="selectedDatasource"
                                :disabled="analyzing || datasources.length === 0"
                            >
                                <option value="">-- è¯·é€‰æ‹©æ•°æ®æº --</option>
                                <option v-for="ds in datasources" :key="ds.name" :value="ds.name">
                                    {{ ds.name }} ({{ ds.url }})
                                </option>
                            </select>
                        </div>
                    </div>
                    <button 
                        class="btn-primary"
                        @click="analyzeTable"
                        :disabled="analyzing || !tableName.trim()"
                    >
                        {{ analyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ' }}
                    </button>

                    <div v-if="analyzeError" class="error">
                        {{ analyzeError }}
                    </div>
                </div>

                <!-- åˆ†æç»“æœ -->
                <div v-if="analysisResult" class="result-section">
                    <div class="result-card">
                        <h3>åˆ†æç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="label">æ€»æŸ¥è¯¢æ•°</div>
                                <div class="value">{{ analysisResult.queryCount }}</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">æ…¢æŸ¥è¯¢æ•°</div>
                                <div class="value" style="color: #f44336;">{{ analysisResult.suggestions?.slowQueries || 0 }}</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">æœªä½¿ç”¨ç´¢å¼•</div>
                                <div class="value" style="color: #ff9800;">{{ analysisResult.suggestions?.queriesWithoutIndex || 0 }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- è¡¨ç»“æ„ -->
                    <div v-if="analysisResult.tableStructure" class="result-card">
                        <h3>è¡¨ç»“æ„ä¿¡æ¯</h3>
                        <div class="table-structure">
                            <h4 style="margin-bottom: 10px;">åˆ—ä¿¡æ¯</h4>
                            <table class="structure-table">
                                <thead>
                                    <tr>
                                        <th>åˆ—å</th>
                                        <th>æ•°æ®ç±»å‹</th>
                                        <th>å¯ç©º</th>
                                        <th>é”®</th>
                                        <th>é»˜è®¤å€¼</th>
                                        <th>é¢å¤–</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="col in analysisResult.tableStructure.columns" :key="col.columnName">
                                        <td>{{ col.columnName }}</td>
                                        <td>{{ col.dataType }}</td>
                                        <td>{{ col.isNullable }}</td>
                                        <td>{{ col.columnKey || '-' }}</td>
                                        <td>{{ col.columnDefault || '-' }}</td>
                                        <td>{{ col.extra || '-' }}</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 style="margin-top: 20px; margin-bottom: 10px;">ç´¢å¼•ä¿¡æ¯</h4>
                            <table class="structure-table">
                                <thead>
                                    <tr>
                                        <th>ç´¢å¼•å</th>
                                        <th>åˆ—å</th>
                                        <th>éå”¯ä¸€</th>
                                        <th>é¡ºåº</th>
                                        <th>ç´¢å¼•ç±»å‹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="idx in analysisResult.tableStructure.indexes" :key="idx.indexName + '-' + idx.columnName">
                                        <td>{{ idx.indexName }}</td>
                                        <td>{{ idx.columnName }}</td>
                                        <td>{{ idx.nonUnique === 0 ? 'å”¯ä¸€' : 'éå”¯ä¸€' }}</td>
                                        <td>{{ idx.seqInIndex }}</td>
                                        <td>{{ idx.indexType }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ä¼˜åŒ–å»ºè®® -->
                    <div v-if="analysisResult.suggestions" class="result-card">
                        <div class="suggestion-header">
                            <h3>ä¼˜åŒ–å»ºè®®</h3>
                            <button 
                                v-if="getOptimizationMarkdown()" 
                                @click="downloadMarkdown" 
                                class="download-btn"
                                title="ä¸‹è½½ Markdown æ–‡æ¡£">
                                ğŸ“¥ ä¸‹è½½ Markdown
                            </button>
                        </div>
                        
                        <div v-if="analysisResult.suggestions.indexSuggestions && analysisResult.suggestions.indexSuggestions.length > 0">
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #666;">ç´¢å¼•å»ºè®®</h4>
                            <ul class="suggestions-list">
                                <li v-for="(suggestion, index) in analysisResult.suggestions.indexSuggestions" :key="index">
                                    {{ suggestion }}
                                </li>
                            </ul>
                        </div>

                        <div v-if="getOptimizationMarkdown()">
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #2196F3;">
                                ğŸ¤– AIæ™ºèƒ½ä¼˜åŒ–å»ºè®®
                            </h4>
                            <div class="markdown-content" v-html="renderMarkdown(getOptimizationMarkdown())"></div>
                        </div>

                        <div v-if="(!analysisResult.suggestions.indexSuggestions || analysisResult.suggestions.indexSuggestions.length === 0) && 
                                   !getOptimizationMarkdown()">
                            <p style="color: #666; margin-top: 15px;">æš‚æ— ä¼˜åŒ–å»ºè®®ï¼Œæ‰€æœ‰æŸ¥è¯¢æ€§èƒ½è‰¯å¥½ã€‚</p>
                        </div>
                    </div>

                    <!-- æŸ¥è¯¢åˆ†æåˆ—è¡¨ -->
                    <div v-if="analysisResult.queryAnalyses && analysisResult.queryAnalyses.length > 0" class="result-card">
                        <h3>æŸ¥è¯¢åˆ†æè¯¦æƒ…</h3>
                        <div class="query-list">
                            <div 
                                v-for="query in analysisResult.queryAnalyses" 
                                :key="query.queryId"
                                :class="['query-item', query.slowQuery ? 'slow' : 'fast']"
                            >
                                <div class="query-header">
                                    <h4>
                                        {{ query.statementId || 'æŸ¥è¯¢ #' + query.queryId }}
                                        <span v-if="query.mapperNamespace" style="color: #666; font-size: 12px; font-weight: normal;">
                                            ({{ query.mapperNamespace }})
                                        </span>
                                    </h4>
                                    <div>
                                        <span :class="['badge', query.slowQuery ? 'badge-danger' : 'badge-success']">
                                            {{ query.slowQuery ? 'æ…¢æŸ¥è¯¢' : 'æ­£å¸¸' }}
                                        </span>
                                        <span v-if="query.queryType" class="badge badge-warning" style="margin-left: 5px;">
                                            {{ query.queryType.toUpperCase() }}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="sql-code">
                                    <div style="margin-bottom: 5px;">
                                        <strong style="color: #666; font-size: 12px;">åŸå§‹SQL:</strong>
                                    </div>
                                    {{ query.sql }}
                                </div>
                                
                                <div v-if="query.executableSql && query.executableSql !== query.sql" 
                                     class="sql-code" 
                                     style="margin-top: 10px; background: #e8f5e9; border-left: 3px solid #4CAF50;">
                                    <div style="margin-bottom: 5px;">
                                        <strong style="color: #2e7d32; font-size: 12px;">å¯æ‰§è¡ŒSQLï¼ˆå·²æ›¿æ¢å‚æ•°ï¼‰:</strong>
                                    </div>
                                    {{ query.executableSql }}
                                </div>
                                
                                <div v-if="query.dynamicConditions" style="margin-top: 8px; font-size: 12px; color: #666;">
                                    åŠ¨æ€æ¡ä»¶: {{ query.dynamicConditions }}
                                </div>

                                <div v-if="query.error" class="error" style="margin-top: 10px;">
                                    {{ query.error }}
                                </div>

                                <div v-else class="query-info">
                                    <div class="info-item">
                                        <strong>ä½¿ç”¨ç´¢å¼•:</strong> {{ query.usesIndex ? 'æ˜¯' : 'å¦' }}
                                    </div>
                                    <div v-if="query.indexName" class="info-item">
                                        <strong>ç´¢å¼•å:</strong> {{ query.indexName }}
                                    </div>
                                    <div v-if="query.accessType" class="info-item">
                                        <strong>è®¿é—®ç±»å‹:</strong> {{ query.accessType }}
                                    </div>
                                    <div v-if="query.rowsExamined !== null && query.rowsExamined !== undefined" class="info-item">
                                        <strong>æ‰«æè¡Œæ•°:</strong> {{ query.rowsExamined }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‚æ•°ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="parameters-tab" class="tab-content">
                <div class="form-section">
                    <h2>Mapperå‚æ•°ç®¡ç†</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        ç®¡ç†ç”¨äºè§£æåŠ¨æ€SQLçš„å‚æ•°ã€‚Mapper IDæ ¼å¼ï¼šnamespace.statementIdï¼ˆä¾‹å¦‚ï¼šcom.example.mapper.UserMapper.selectByIdï¼‰<br>
                        <strong>æ”¯æŒå±‚çº§é…ç½®ï¼š</strong>å¯ä»¥é…ç½®åˆ°ä»»æ„å±‚çº§ï¼ˆå¦‚ï¼šcom.example.demoï¼‰ï¼ŒæŸ¥æ‰¾æ—¶ä¼šä»æœ€å…·ä½“åˆ°æœ€å¤–å±‚é€çº§æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚
                    </p>
                    
                    <!-- æ·»åŠ /ç¼–è¾‘å‚æ•°è¡¨å• -->
                    <div class="form-section" style="background: #f9f9f9; padding: 20px; border-radius: 4px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">{{ editingParameter ? 'ç¼–è¾‘å‚æ•°' : 'æ·»åŠ æ–°å‚æ•°' }}</h3>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="param-mapper-id">Mapper IDï¼š</label>
                            <input 
                                type="text" 
                                id="param-mapper-id"
                                v-model="parameterForm.mapperId"
                                placeholder="ä¾‹å¦‚: com.example.mapper.UserMapper.selectById æˆ– com.example.mapper.UserMapper"
                                :disabled="savingParameter"
                            />
                            <small style="color: #666; display: block; margin-top: 5px;">
                                æ”¯æŒå®Œæ•´è·¯å¾„ï¼ˆå¦‚ï¼šcom.example.demo.selectByKeyï¼‰æˆ–å‘½åç©ºé—´å±‚çº§ï¼ˆå¦‚ï¼šcom.example.demoï¼‰
                            </small>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="param-json">å‚æ•°JSONï¼š</label>
                            <textarea 
                                id="param-json"
                                v-model="parameterForm.parameterJson"
                                placeholder='ä¾‹å¦‚: {"id": 1, "username": "test", "status": "active"}'
                                :disabled="savingParameter"
                                style="min-height: 150px; font-family: 'Courier New', monospace;"
                            ></textarea>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                è¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œå°†è¢«è§£æä¸ºMap&lt;String,Object&gt;
                            </small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button 
                                class="btn-primary"
                                @click="saveParameter"
                                :disabled="savingParameter || !parameterForm.mapperId.trim() || !parameterForm.parameterJson.trim()"
                            >
                                {{ savingParameter ? 'ä¿å­˜ä¸­...' : (editingParameter ? 'æ›´æ–°' : 'ä¿å­˜') }}
                            </button>
                            <button 
                                v-if="editingParameter"
                                class="btn-secondary"
                                @click="cancelEdit"
                                :disabled="savingParameter"
                            >
                                å–æ¶ˆ
                            </button>
                        </div>
                        <div v-if="parameterError" class="error" style="margin-top: 15px;">
                            {{ parameterError }}
                        </div>
                        <div v-if="parameterSuccess" class="success" style="margin-top: 15px;">
                            {{ parameterSuccess }}
                        </div>
                    </div>

                    <!-- å‚æ•°åˆ—è¡¨ -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; font-size: 16px;">å‚æ•°åˆ—è¡¨ï¼ˆå…± {{ parameters.length }} æ¡ï¼‰</h3>
                            <button 
                                class="btn-secondary"
                                @click="loadParameters"
                                :disabled="loadingParameters"
                            >
                                {{ loadingParameters ? 'åŠ è½½ä¸­...' : 'åˆ·æ–°' }}
                            </button>
                        </div>
                        
                        <div v-if="loadingParameters" class="loading">
                            åŠ è½½ä¸­...
                        </div>
                        
                        <div v-else-if="parameters.length === 0" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— å‚æ•°ï¼Œè¯·æ·»åŠ æ–°å‚æ•°
                        </div>
                        
                        <div v-else class="query-list">
                            <div v-for="param in parameters" :key="param.mapperId" class="query-item">
                                <div class="query-header">
                                    <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">
                                        {{ param.mapperId }}
                                    </h4>
                                    <div style="display: flex; gap: 10px;">
                                        <button 
                                            class="btn-secondary"
                                            style="padding: 6px 12px; font-size: 12px;"
                                            @click="editParameter(param)"
                                        >
                                            ç¼–è¾‘
                                        </button>
                                        <button 
                                            class="btn-danger"
                                            style="padding: 6px 12px; font-size: 12px; background: #f44336;"
                                            @click="deleteParameter(param.mapperId)"
                                        >
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                        <strong>å‚æ•°JSONï¼š</strong>
                                    </div>
                                    <div class="sql-code" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
                                        {{ param.parameterJson }}
                                    </div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        åˆ›å»ºæ—¶é—´ï¼š{{ formatDateTime(param.createdAt) }} | 
                                        æ›´æ–°æ—¶é—´ï¼š{{ formatDateTime(param.updatedAt) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡å€¼ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="statistic-values-tab" class="tab-content">
                <div class="form-section">
                    <h2>åˆ—ç»Ÿè®¡å€¼ç®¡ç†</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        ç®¡ç†è¡¨çš„åˆ—ç»Ÿè®¡å€¼ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€ä¸­ä½å€¼ç­‰ï¼‰ã€‚å¯ä»¥ä»ColumnStatisticsè‡ªåŠ¨è®¡ç®—ï¼Œä¹Ÿå¯ä»¥æ‰‹å·¥æ·»åŠ ã€‚
                    </p>
                    
                    <!-- è¡¨é€‰æ‹©åŒºåŸŸ -->
                    <div class="form-section" style="background: #f9f9f9; padding: 20px; border-radius: 4px; margin-bottom: 30px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="stat-datasource">æ•°æ®æºï¼š</label>
                                <select 
                                    id="stat-datasource"
                                    v-model="statisticForm.datasourceName"
                                    :disabled="loadingStatisticValues || datasources.length === 0"
                                >
                                    <option value="">-- è¯·é€‰æ‹©æ•°æ®æº --</option>
                                    <option v-for="ds in datasources" :key="ds.name" :value="ds.name">
                                        {{ ds.name }} ({{ ds.url }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="stat-table-name">è¡¨åï¼š</label>
                                <input 
                                    type="text" 
                                    id="stat-table-name"
                                    v-model="statisticForm.tableName"
                                    placeholder="ä¾‹å¦‚: users"
                                    :disabled="loadingStatisticValues"
                                />
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button 
                                class="btn-primary"
                                @click="loadStatisticValues"
                                :disabled="loadingStatisticValues || !statisticForm.datasourceName || !statisticForm.tableName"
                            >
                                {{ loadingStatisticValues ? 'åŠ è½½ä¸­...' : 'åŠ è½½ç»Ÿè®¡å€¼' }}
                            </button>
                            <button 
                                class="btn-secondary"
                                @click="calculateStatisticValues"
                                :disabled="calculatingStatisticValues || !statisticForm.datasourceName || !statisticForm.tableName"
                            >
                                {{ calculatingStatisticValues ? 'è®¡ç®—ä¸­...' : 'è®¡ç®—ç»Ÿè®¡å€¼' }}
                            </button>
                        </div>
                        <div v-if="statisticError" class="error" style="margin-top: 15px;">
                            {{ statisticError }}
                        </div>
                        <div v-if="statisticSuccess" class="success" style="margin-top: 15px;">
                            {{ statisticSuccess }}
                        </div>
                    </div>

                    <!-- æ·»åŠ /ç¼–è¾‘ç»Ÿè®¡å€¼è¡¨å• -->
                    <div class="form-section" style="background: #f9f9f9; padding: 20px; border-radius: 4px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; font-size: 16px;">{{ editingStatisticValue ? 'ç¼–è¾‘ç»Ÿè®¡å€¼' : 'æ·»åŠ ç»Ÿè®¡å€¼' }}</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="stat-column-name">åˆ—åï¼š</label>
                                <input 
                                    type="text" 
                                    id="stat-column-name"
                                    v-model="statisticValueForm.columnName"
                                    placeholder="ä¾‹å¦‚: id"
                                    :disabled="savingStatisticValue"
                                />
                            </div>
                            <div class="form-group">
                                <label for="stat-type">ç»Ÿè®¡ç±»å‹ï¼š</label>
                                <select 
                                    id="stat-type"
                                    v-model="statisticValueForm.statisticType"
                                    :disabled="savingStatisticValue"
                                >
                                    <option value="">-- è¯·é€‰æ‹©ç±»å‹ --</option>
                                    <option value="MIN">æœ€å°å€¼ (MIN)</option>
                                    <option value="MAX">æœ€å¤§å€¼ (MAX)</option>
                                    <option value="MEDIAN">ä¸­ä½å€¼ (MEDIAN)</option>
                                    <option value="PERCENTILE_25">å››åˆ†ä¹‹ä¸€ä¸­ä½å€¼ (PERCENTILE_25)</option>
                                    <option value="PERCENTILE_75">å››åˆ†ä¹‹ä¸‰ä¸­ä½å€¼ (PERCENTILE_75)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="stat-value">ç»Ÿè®¡å€¼ï¼š</label>
                            <input 
                                type="text" 
                                id="stat-value"
                                v-model="statisticValueForm.statisticValue"
                                placeholder="ä¾‹å¦‚: 100 æˆ– 'test'"
                                :disabled="savingStatisticValue"
                            />
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button 
                                class="btn-primary"
                                @click="saveStatisticValue"
                                :disabled="savingStatisticValue || !statisticValueForm.columnName || !statisticValueForm.statisticType || !statisticValueForm.statisticValue"
                            >
                                {{ savingStatisticValue ? 'ä¿å­˜ä¸­...' : (editingStatisticValue ? 'æ›´æ–°' : 'ä¿å­˜') }}
                            </button>
                            <button 
                                v-if="editingStatisticValue"
                                class="btn-secondary"
                                @click="cancelEditStatisticValue"
                                :disabled="savingStatisticValue"
                            >
                                å–æ¶ˆ
                            </button>
                            <label style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
                                <input 
                                    type="checkbox" 
                                    v-model="statisticValueForm.isManual"
                                    :disabled="savingStatisticValue"
                                />
                                <span>æ‰‹å·¥æ·»åŠ </span>
                            </label>
                        </div>
                        <div v-if="statisticValueError" class="error" style="margin-top: 15px;">
                            {{ statisticValueError }}
                        </div>
                        <div v-if="statisticValueSuccess" class="success" style="margin-top: 15px;">
                            {{ statisticValueSuccess }}
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡å€¼åˆ—è¡¨ -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; font-size: 16px;">ç»Ÿè®¡å€¼åˆ—è¡¨ï¼ˆå…± {{ statisticValues.length }} æ¡ï¼‰</h3>
                            <button 
                                class="btn-secondary"
                                @click="loadStatisticValues"
                                :disabled="loadingStatisticValues"
                            >
                                {{ loadingStatisticValues ? 'åŠ è½½ä¸­...' : 'åˆ·æ–°' }}
                            </button>
                        </div>
                        
                        <div v-if="loadingStatisticValues" class="loading">
                            åŠ è½½ä¸­...
                        </div>
                        
                        <div v-else-if="statisticValues.length === 0" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— ç»Ÿè®¡å€¼ï¼Œè¯·å…ˆé€‰æ‹©æ•°æ®æºå’Œè¡¨åï¼Œç„¶åç‚¹å‡»"è®¡ç®—ç»Ÿè®¡å€¼"æˆ–"æ·»åŠ ç»Ÿè®¡å€¼"
                        </div>
                        
                        <div v-else>
                            <table class="structure-table" style="margin-top: 0;">
                                <thead>
                                    <tr>
                                        <th>åˆ—å</th>
                                        <th>ç»Ÿè®¡ç±»å‹</th>
                                        <th>ç»Ÿè®¡å€¼</th>
                                        <th>æ¥æº</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ›´æ–°æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="value in statisticValues" :key="value.id">
                                        <td>{{ value.columnName }}</td>
                                        <td>{{ value.statisticType }}</td>
                                        <td style="font-family: 'Courier New', monospace;">{{ value.statisticValue }}</td>
                                        <td>
                                            <span :style="{ color: value.isManual ? '#ff9800' : '#4CAF50', fontWeight: '600' }">
                                                {{ value.isManual ? 'æ‰‹å·¥' : 'è‡ªåŠ¨' }}
                                            </span>
                                        </td>
                                        <td>{{ formatDateTime(value.createdAt) }}</td>
                                        <td>{{ formatDateTime(value.updatedAt) }}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button 
                                                    class="btn-secondary"
                                                    style="padding: 4px 8px; font-size: 12px;"
                                                    @click="editStatisticValue(value)"
                                                >
                                                    ç¼–è¾‘
                                                </button>
                                                <button 
                                                    class="btn-danger"
                                                    style="padding: 4px 8px; font-size: 12px;"
                                                    @click="deleteStatisticValue(value.id)"
                                                >
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 -->
    <script src="/libs/vue/vue.global.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'upload',
                    // ä¸Šä¼ ç›¸å…³
                    mapperNamespace: '',
                    xmlContent: '',
                    uploading: false,
                    uploadError: null,
                    uploadSuccess: null,
                    // åˆ†æç›¸å…³
                    tableName: '',
                    selectedDatasource: '',
                    datasources: [],
                    analyzing: false,
                    analyzeError: null,
                    analysisResult: null,
                    // å‚æ•°ç®¡ç†ç›¸å…³
                    parameters: [],
                    loadingParameters: false,
                    savingParameter: false,
                    parameterError: null,
                    parameterSuccess: null,
                    editingParameter: null,
                    parameterForm: {
                        mapperId: '',
                        parameterJson: ''
                    },
                    // ç»Ÿè®¡å€¼ç®¡ç†ç›¸å…³
                    statisticForm: {
                        datasourceName: '',
                        tableName: ''
                    },
                    statisticValues: [],
                    loadingStatisticValues: false,
                    calculatingStatisticValues: false,
                    statisticError: null,
                    statisticSuccess: null,
                    editingStatisticValue: null,
                    savingStatisticValue: false,
                    statisticValueError: null,
                    statisticValueSuccess: null,
                    statisticValueForm: {
                        columnName: '',
                        statisticType: '',
                        statisticValue: '',
                        isManual: true
                    }
                };
            },
            mounted() {
                this.loadDatasources();
            },
            methods: {
                switchTab(tab) {
                    this.activeTab = tab;
                    // æ›´æ–°tabæŒ‰é’®çŠ¶æ€
                    const tabs = ['upload', 'analyze', 'parameters', 'statistic-values'];
                    document.querySelectorAll('.tab').forEach((t, index) => {
                        t.classList.remove('active');
                        if (tabs[index] === tab) {
                            t.classList.add('active');
                        }
                    });
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tab + '-tab').classList.add('active');
                    
                    // åˆ‡æ¢åˆ°å‚æ•°ç®¡ç†æ ‡ç­¾é¡µæ—¶åŠ è½½å‚æ•°åˆ—è¡¨
                    if (tab === 'parameters') {
                        this.loadParameters();
                    }
                    // åˆ‡æ¢åˆ°ç»Ÿè®¡å€¼ç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œå¦‚æœå·²é€‰æ‹©æ•°æ®æºå’Œè¡¨åï¼Œåˆ™åŠ è½½ç»Ÿè®¡å€¼
                    if (tab === 'statistic-values' && this.statisticForm.datasourceName && this.statisticForm.tableName) {
                        this.loadStatisticValues();
                    }
                },
                async loadDatasources() {
                    try {
                        const response = await fetch('/api/sql/datasources');
                        if (response.ok) {
                            this.datasources = await response.json();
                            if (this.datasources.length === 1) {
                                this.selectedDatasource = this.datasources[0].name;
                                this.statisticForm.datasourceName = this.datasources[0].name;
                            }
                        }
                    } catch (err) {
                        console.error('åŠ è½½æ•°æ®æºåˆ—è¡¨é”™è¯¯:', err);
                    }
                },
                async uploadMapperXml() {
                    if (!this.mapperNamespace.trim() || !this.xmlContent.trim()) {
                        this.uploadError = 'è¯·å¡«å†™Mapperå‘½åç©ºé—´å’ŒXMLå†…å®¹';
                        return;
                    }

                    this.uploading = true;
                    this.uploadError = null;
                    this.uploadSuccess = null;

                    try {
                        const response = await fetch('/api/mybatis/upload', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                mapperNamespace: this.mapperNamespace.trim(),
                                xmlContent: this.xmlContent.trim()
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                        }

                        this.uploadSuccess = `æˆåŠŸè§£æ ${data.queryCount} ä¸ªSQLæŸ¥è¯¢ï¼`;
                        // æ¸…ç©ºè¡¨å•
                        this.xmlContent = '';
                    } catch (err) {
                        this.uploadError = err.message || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                        console.error('ä¸Šä¼ é”™è¯¯:', err);
                    } finally {
                        this.uploading = false;
                    }
                },
                async analyzeTable() {
                    if (!this.tableName.trim()) {
                        this.analyzeError = 'è¯·è¾“å…¥è¡¨å';
                        return;
                    }

                    this.analyzing = true;
                    this.analyzeError = null;
                    this.analysisResult = null;

                    try {
                        let url = `/api/analysis/table/${encodeURIComponent(this.tableName.trim())}`;
                        if (this.selectedDatasource) {
                            url += `?datasourceName=${encodeURIComponent(this.selectedDatasource)}`;
                        }

                        const response = await fetch(url);

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'åˆ†æå¤±è´¥');
                        }

                        if (!data.success) {
                            throw new Error(data.message || 'åˆ†æå¤±è´¥');
                        }

                        this.analysisResult = data;
                    } catch (err) {
                        this.analyzeError = err.message || 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                        console.error('åˆ†æé”™è¯¯:', err);
                    } finally {
                        this.analyzing = false;
                    }
                },
                async loadParameters() {
                    this.loadingParameters = true;
                    this.parameterError = null;
                    
                    try {
                        const response = await fetch('/api/mybatis/parameters');
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                        }
                        
                        this.parameters = data.parameters || [];
                    } catch (err) {
                        this.parameterError = err.message || 'åŠ è½½å‚æ•°åˆ—è¡¨å¤±è´¥';
                        console.error('åŠ è½½å‚æ•°é”™è¯¯:', err);
                    } finally {
                        this.loadingParameters = false;
                    }
                },
                async saveParameter() {
                    if (!this.parameterForm.mapperId.trim() || !this.parameterForm.parameterJson.trim()) {
                        this.parameterError = 'è¯·å¡«å†™Mapper IDå’Œå‚æ•°JSON';
                        return;
                    }
                    
                    // éªŒè¯JSONæ ¼å¼
                    try {
                        JSON.parse(this.parameterForm.parameterJson);
                    } catch (e) {
                        this.parameterError = 'å‚æ•°JSONæ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥JSONè¯­æ³•';
                        return;
                    }
                    
                    this.savingParameter = true;
                    this.parameterError = null;
                    this.parameterSuccess = null;
                    
                    try {
                        const response = await fetch('/api/mybatis/parameters', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                mapperId: this.parameterForm.mapperId.trim(),
                                parameters: JSON.parse(this.parameterForm.parameterJson)
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
                        }
                        
                        this.parameterSuccess = 'å‚æ•°ä¿å­˜æˆåŠŸï¼';
                        this.resetParameterForm();
                        await this.loadParameters();
                    } catch (err) {
                        this.parameterError = err.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                        console.error('ä¿å­˜å‚æ•°é”™è¯¯:', err);
                    } finally {
                        this.savingParameter = false;
                    }
                },
                editParameter(param) {
                    this.editingParameter = param;
                    this.parameterForm.mapperId = param.mapperId;
                    this.parameterForm.parameterJson = param.parameterJson;
                    // æ»šåŠ¨åˆ°è¡¨å•
                    document.getElementById('param-mapper-id').scrollIntoView({ behavior: 'smooth', block: 'start' });
                },
                cancelEdit() {
                    this.resetParameterForm();
                },
                resetParameterForm() {
                    this.parameterForm.mapperId = '';
                    this.parameterForm.parameterJson = '';
                    this.editingParameter = null;
                    this.parameterError = null;
                    this.parameterSuccess = null;
                },
                async deleteParameter(mapperId) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤å‚æ•° "${mapperId}" å—ï¼Ÿ`)) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/mybatis/parameters/${encodeURIComponent(mapperId)}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                        }
                        
                        this.parameterSuccess = 'å‚æ•°åˆ é™¤æˆåŠŸï¼';
                        await this.loadParameters();
                    } catch (err) {
                        this.parameterError = err.message || 'åˆ é™¤å¤±è´¥';
                        console.error('åˆ é™¤å‚æ•°é”™è¯¯:', err);
                    }
                },
                formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return '-';
                    try {
                        const date = new Date(dateTimeStr);
                        return date.toLocaleString('zh-CN');
                    } catch (e) {
                        return dateTimeStr;
                    }
                },
                async loadStatisticValues() {
                    if (!this.statisticForm.datasourceName || !this.statisticForm.tableName) {
                        this.statisticError = 'è¯·é€‰æ‹©æ•°æ®æºå’Œè¡¨å';
                        return;
                    }
                    
                    this.loadingStatisticValues = true;
                    this.statisticError = null;
                    this.statisticSuccess = null;
                    
                    try {
                        const url = `/api/statistic-values?datasourceName=${encodeURIComponent(this.statisticForm.datasourceName)}&tableName=${encodeURIComponent(this.statisticForm.tableName)}`;
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                        }
                        
                        this.statisticValues = data.values || [];
                        if (this.statisticValues.length === 0) {
                            this.statisticSuccess = 'æš‚æ— ç»Ÿè®¡å€¼ï¼Œå¯ä»¥ç‚¹å‡»"è®¡ç®—ç»Ÿè®¡å€¼"æŒ‰é’®è‡ªåŠ¨è®¡ç®—';
                        }
                    } catch (err) {
                        this.statisticError = err.message || 'åŠ è½½ç»Ÿè®¡å€¼å¤±è´¥';
                        console.error('åŠ è½½ç»Ÿè®¡å€¼é”™è¯¯:', err);
                    } finally {
                        this.loadingStatisticValues = false;
                    }
                },
                async calculateStatisticValues() {
                    if (!this.statisticForm.datasourceName || !this.statisticForm.tableName) {
                        this.statisticError = 'è¯·é€‰æ‹©æ•°æ®æºå’Œè¡¨å';
                        return;
                    }
                    
                    this.calculatingStatisticValues = true;
                    this.statisticError = null;
                    this.statisticSuccess = null;
                    
                    try {
                        const response = await fetch('/api/statistic-values/calculate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                datasourceName: this.statisticForm.datasourceName,
                                tableName: this.statisticForm.tableName
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'è®¡ç®—å¤±è´¥');
                        }
                        
                        this.statisticSuccess = `æˆåŠŸè®¡ç®— ${data.count} ä¸ªç»Ÿè®¡å€¼ï¼`;
                        await this.loadStatisticValues();
                    } catch (err) {
                        this.statisticError = err.message || 'è®¡ç®—ç»Ÿè®¡å€¼å¤±è´¥';
                        console.error('è®¡ç®—ç»Ÿè®¡å€¼é”™è¯¯:', err);
                    } finally {
                        this.calculatingStatisticValues = false;
                    }
                },
                async saveStatisticValue() {
                    if (!this.statisticForm.datasourceName || !this.statisticForm.tableName) {
                        this.statisticValueError = 'è¯·å…ˆé€‰æ‹©æ•°æ®æºå’Œè¡¨å';
                        return;
                    }
                    
                    if (!this.statisticValueForm.columnName || !this.statisticValueForm.statisticType || !this.statisticValueForm.statisticValue) {
                        this.statisticValueError = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ';
                        return;
                    }
                    
                    this.savingStatisticValue = true;
                    this.statisticValueError = null;
                    this.statisticValueSuccess = null;
                    
                    try {
                        const response = await fetch('/api/statistic-values', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                datasourceName: this.statisticForm.datasourceName,
                                tableName: this.statisticForm.tableName,
                                columnName: this.statisticValueForm.columnName,
                                statisticType: this.statisticValueForm.statisticType,
                                statisticValue: this.statisticValueForm.statisticValue,
                                isManual: this.statisticValueForm.isManual !== false
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
                        }
                        
                        this.statisticValueSuccess = 'ç»Ÿè®¡å€¼ä¿å­˜æˆåŠŸï¼';
                        this.resetStatisticValueForm();
                        await this.loadStatisticValues();
                    } catch (err) {
                        this.statisticValueError = err.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                        console.error('ä¿å­˜ç»Ÿè®¡å€¼é”™è¯¯:', err);
                    } finally {
                        this.savingStatisticValue = false;
                    }
                },
                editStatisticValue(value) {
                    this.editingStatisticValue = value;
                    this.statisticValueForm.columnName = value.columnName;
                    this.statisticValueForm.statisticType = value.statisticType;
                    this.statisticValueForm.statisticValue = value.statisticValue;
                    this.statisticValueForm.isManual = value.isManual;
                    // æ»šåŠ¨åˆ°è¡¨å•
                    document.getElementById('stat-column-name').scrollIntoView({ behavior: 'smooth', block: 'start' });
                },
                cancelEditStatisticValue() {
                    this.resetStatisticValueForm();
                },
                resetStatisticValueForm() {
                    this.statisticValueForm.columnName = '';
                    this.statisticValueForm.statisticType = '';
                    this.statisticValueForm.statisticValue = '';
                    this.statisticValueForm.isManual = true;
                    this.editingStatisticValue = null;
                    this.statisticValueError = null;
                    this.statisticValueSuccess = null;
                },
                async deleteStatisticValue(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç»Ÿè®¡å€¼å—ï¼Ÿ')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/statistic-values/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                        }
                        
                        this.statisticSuccess = 'ç»Ÿè®¡å€¼åˆ é™¤æˆåŠŸï¼';
                        await this.loadStatisticValues();
                    } catch (err) {
                        this.statisticError = err.message || 'åˆ é™¤å¤±è´¥';
                        console.error('åˆ é™¤ç»Ÿè®¡å€¼é”™è¯¯:', err);
                    }
                },
                getOptimizationMarkdown() {
                    if (!this.analysisResult || !this.analysisResult.suggestions) {
                        return null;
                    }
                    const suggestions = this.analysisResult.suggestions;
                    // ä¼˜å…ˆä½¿ç”¨ aiSuggestionsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ sqlSuggestions
                    if (suggestions.aiSuggestions && suggestions.aiSuggestions.trim()) {
                        return suggestions.aiSuggestions;
                    }
                    if (suggestions.sqlSuggestions && suggestions.sqlSuggestions.length > 0) {
                        return suggestions.sqlSuggestions.join('\n\n');
                    }
                    return null;
                },
                renderMarkdown(markdown) {
                    if (!markdown) return '';
                    try {
                        // é…ç½® marked é€‰é¡¹
                        if (typeof marked !== 'undefined') {
                            marked.setOptions({
                                breaks: true,
                                gfm: true,
                                headerIds: true,
                                mangle: false
                            });
                            return marked.parse(markdown);
                        }
                        // å¦‚æœ marked æœªåŠ è½½ï¼Œè¿”å›åŸå§‹æ–‡æœ¬ï¼ˆè½¬ä¹‰ HTMLï¼‰
                        return markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
                    } catch (e) {
                        console.error('Markdown æ¸²æŸ“é”™è¯¯:', e);
                        return markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
                    }
                },
                downloadMarkdown() {
                    const markdown = this.getOptimizationMarkdown();
                    if (!markdown) {
                        alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¼˜åŒ–å»ºè®®å†…å®¹');
                        return;
                    }

                    // æ„å»ºå®Œæ•´çš„ markdown æ–‡æ¡£
                    const tableName = this.analysisResult?.tableName || 'æœªçŸ¥è¡¨';
                    const datasourceName = this.analysisResult?.datasourceName || '';
                    const queryCount = this.analysisResult?.queryCount || 0;
                    const timestamp = new Date().toLocaleString('zh-CN');

                    let fullMarkdown = `# ${tableName} è¡¨ä¼˜åŒ–å»ºè®®\n\n`;
                    fullMarkdown += `**ç”Ÿæˆæ—¶é—´**: ${timestamp}\n\n`;
                    if (datasourceName) {
                        fullMarkdown += `**æ•°æ®æº**: ${datasourceName}\n\n`;
                    }
                    fullMarkdown += `**æŸ¥è¯¢æ•°é‡**: ${queryCount}\n\n`;
                    fullMarkdown += `---\n\n`;

                    // æ·»åŠ ç´¢å¼•å»ºè®®
                    if (this.analysisResult?.suggestions?.indexSuggestions && 
                        this.analysisResult.suggestions.indexSuggestions.length > 0) {
                        fullMarkdown += `## ç´¢å¼•å»ºè®®\n\n`;
                        this.analysisResult.suggestions.indexSuggestions.forEach(suggestion => {
                            fullMarkdown += `- ${suggestion}\n`;
                        });
                        fullMarkdown += `\n`;
                    }

                    // æ·»åŠ  AI ä¼˜åŒ–å»ºè®®
                    fullMarkdown += `## AIæ™ºèƒ½ä¼˜åŒ–å»ºè®®\n\n`;
                    fullMarkdown += markdown;

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = new Blob([fullMarkdown], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${tableName}_ä¼˜åŒ–å»ºè®®_${new Date().toISOString().split('T')[0]}.md`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

