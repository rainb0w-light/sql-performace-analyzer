# 内网部署说明

## 一、静态资源本地化

### 已完成的工作

所有 CDN 资源已下载到本地，位于 `src/main/resources/static/libs/` 目录：

- **Vue 3**: `libs/vue/vue.global.js`
- **Marked**: `libs/marked/marked.min.js`
- **html2pdf.js**: `libs/html2pdf/html2pdf.bundle.min.js`

`index.html` 已更新为使用本地资源路径，不再依赖外部 CDN。

## 二、Spring AI 依赖缺失问题分析

### 问题描述

内网 Gradle 制品库缺少 `spring-ai-openai-spring-boot-starter:1.0.0-M4` 依赖。

### 原因分析

1. **里程碑版本特性**
   - `1.0.0-M4` 是 Spring AI 的里程碑版本（Milestone）
   - 里程碑版本通常只在 Spring Milestone 仓库中提供
   - 官方仓库地址：`https://repo.spring.io/milestone`

2. **内网制品库限制**
   - 内网 Gradle 制品库通常只同步 Maven Central 的稳定版本
   - Spring Milestone 仓库可能未被同步或代理
   - 里程碑版本不在 Maven Central 发布

3. **版本状态**
   - M4 表示 Milestone 4，属于预发布版本
   - 该版本可能尚未发布到 Maven Central
   - 需要从 Spring 官方 Milestone 仓库获取

4. **依赖命名变更（重要）**
   - Spring AI 在后续版本中更改了依赖命名规则
   - 旧命名：`spring-ai-{model}-spring-boot-starter`（如 `spring-ai-openai-spring-boot-starter`）
   - 新命名：`spring-ai-starter-model-{model}`（如 `spring-ai-starter-model-openai`）
   - `1.0.0-M4` 版本仍使用旧命名，但后续版本使用新命名

### 解决方案

#### 方案一：配置内网仓库代理 Spring Milestone 仓库（推荐）

在内网 Gradle 制品库（如 Nexus、Artifactory）中配置 Spring Milestone 仓库的代理：

1. **在制品库管理界面添加远程仓库**：
   - 仓库类型：Maven Proxy
   - 仓库名称：spring-milestone
   - 远程 URL：`https://repo.spring.io/milestone`
   - 发布策略：Allow Redeploy

2. **将 Spring Milestone 仓库添加到仓库组**（如果使用仓库组）

3. **更新项目的 `build.gradle`**，确保内网仓库配置正确：

```gradle
repositories {
    // 内网制品库（优先）
    maven {
        url = uri("http://your-internal-repo:8081/repository/maven-public/")
        // 如果需要认证
        credentials {
            username = project.findProperty('repoUsername') ?: ''
            password = project.findProperty('repoPassword') ?: ''
        }
    }
    // 如果内网仓库没有，则回退到 Spring Milestone
    maven {
        url = uri("https://repo.spring.io/milestone")
    }
    mavenCentral()
}
```

#### 方案二：手动下载并安装到本地 Maven 仓库

如果无法配置内网仓库代理，可以手动下载依赖：

1. **下载依赖文件**（在有外网的环境中）：

```bash
# 下载 POM 文件
curl -O https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.pom

# 下载 JAR 文件
curl -O https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.jar
```

2. **安装到本地 Maven 仓库**：

```bash
mvn install:install-file \
  -Dfile=spring-ai-openai-spring-boot-starter-1.0.0-M4.jar \
  -DgroupId=org.springframework.ai \
  -DartifactId=spring-ai-openai-spring-boot-starter \
  -Dversion=1.0.0-M4 \
  -Dpackaging=jar \
  -DpomFile=spring-ai-openai-spring-boot-starter-1.0.0-M4.pom
```

3. **或者安装到内网制品库**（如果有上传权限）：

```bash
mvn deploy:deploy-file \
  -Dfile=spring-ai-openai-spring-boot-starter-1.0.0-M4.jar \
  -DgroupId=org.springframework.ai \
  -DartifactId=spring-ai-openai-spring-boot-starter \
  -Dversion=1.0.0-M4 \
  -Dpackaging=jar \
  -DpomFile=spring-ai-openai-spring-boot-starter-1.0.0-M4.pom \
  -DrepositoryId=internal-repo \
  -Durl=http://your-internal-repo:8081/repository/maven-releases/
```

**注意**：还需要下载所有传递依赖（transitive dependencies），可以使用以下命令：

```bash
# 使用 Gradle 下载所有依赖
./gradlew dependencies --configuration runtimeClasspath > dependencies.txt

# 或者使用 Maven
mvn dependency:tree > dependencies.txt
```

#### 方案三：使用稳定版本（如果可用）

检查是否有稳定版本可用：

1. **查看 Spring AI 官方文档**：https://spring.io/projects/spring-ai
2. **检查 Maven Central**：https://mvnrepository.com/artifact/org.springframework.ai
3. **如果找到稳定版本**，更新 `build.gradle`：

```gradle
dependencies {
    // 如果使用稳定版本，注意依赖命名可能已变更
    // 旧命名（1.0.0-M4 及之前）：
    // implementation 'org.springframework.ai:spring-ai-openai-spring-boot-starter:1.0.0-M4'
    
    // 新命名（1.0.0-M5 及之后）：
    // implementation 'org.springframework.ai:spring-ai-starter-model-openai:1.0.0'
}
```

**注意**：如果升级到新版本，还需要更新代码中的包名和配置，因为 Spring AI 的 API 在不同版本间可能有变化。

#### 方案四：使用本地文件依赖（临时方案）

如果以上方案都不可行，可以下载所有依赖到本地目录：

1. **创建本地仓库目录**：`libs/maven-repo/`

2. **下载依赖到本地目录**（在有外网的环境中）

3. **配置 `build.gradle` 使用本地仓库**：

```gradle
repositories {
    flatDir {
        dirs 'libs/maven-repo'
    }
    mavenCentral()
}
```

### 推荐方案

**优先使用方案一**（配置内网仓库代理），因为：
- 一次配置，长期受益
- 自动处理传递依赖
- 便于团队共享
- 符合企业级最佳实践

如果无法配置内网仓库，则使用**方案二**（手动安装），但需要确保下载所有传递依赖。

## 三、验证步骤

完成依赖配置后，执行以下命令验证：

```bash
# 清理并重新构建
./gradlew clean build

# 查看依赖树
./gradlew dependencies --configuration runtimeClasspath

# 运行应用
./gradlew bootRun
```

## 四、相关资源

- Spring AI 官方文档：https://spring.io/projects/spring-ai
- Spring Milestone 仓库：https://repo.spring.io/milestone
- Maven Central：https://mvnrepository.com/artifact/org.springframework.ai

