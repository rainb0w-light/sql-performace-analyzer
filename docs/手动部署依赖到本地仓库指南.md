# 手动下载并部署 Spring AI 依赖到本地 Maven 仓库指南

本指南详细说明如何手动下载 `spring-ai-openai-spring-boot-starter:1.0.0-M4` 及其所有传递依赖，并安装到本地 Maven 仓库。

## 前置条件

1. **有外网访问权限的机器**（用于下载依赖）
2. **已安装 Maven**（用于安装依赖到本地仓库）
3. **已安装 Gradle**（可选，用于分析依赖树）

## 方法一：使用提供的脚本下载（推荐）

### Windows 环境

1. **运行下载脚本**：

```powershell
cd D:\IdeaProjects\demo\sql-performance-analyzer
.\scripts\download-spring-ai-dependencies.ps1
```

脚本会自动下载主依赖的 POM 和 JAR 文件到 `spring-ai-dependencies` 目录。

### Linux/Mac 环境

```bash
cd /path/to/sql-performance-analyzer
chmod +x scripts/download-spring-ai-dependencies.sh
./scripts/download-spring-ai-dependencies.sh
```

## 方法二：手动下载主依赖

### 步骤 1：下载主依赖文件

在有外网的环境中，手动下载以下文件：

**POM 文件**：
```
https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.pom
```

**JAR 文件**：
```
https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.jar
```

**使用 curl 下载（Linux/Mac）**：
```bash
mkdir -p spring-ai-dependencies
cd spring-ai-dependencies

# 下载 POM
curl -O https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.pom

# 下载 JAR
curl -O https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.jar
```

**使用 PowerShell 下载（Windows）**：
```powershell
New-Item -ItemType Directory -Force -Path spring-ai-dependencies
cd spring-ai-dependencies

# 下载 POM
Invoke-WebRequest -Uri "https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.pom" -OutFile "spring-ai-openai-spring-boot-starter-1.0.0-M4.pom"

# 下载 JAR
Invoke-WebRequest -Uri "https://repo.spring.io/milestone/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4/spring-ai-openai-spring-boot-starter-1.0.0-M4.jar" -OutFile "spring-ai-openai-spring-boot-starter-1.0.0-M4.jar"
```

## 步骤 2：分析并下载传递依赖

主依赖会依赖其他库，我们需要下载所有传递依赖。

### 方法 A：使用 Gradle 分析依赖树（推荐）

1. **在有外网的环境中，临时修改 `build.gradle`**，添加 Spring Milestone 仓库：

```gradle
repositories {
    mavenCentral()
    maven {
        url = uri("https://repo.spring.io/milestone")
    }
}
```

2. **生成依赖树**：

```bash
./gradlew dependencies --configuration runtimeClasspath > dependencies.txt
```

3. **查看依赖树文件**，找出所有需要下载的依赖：

```bash
# Linux/Mac
cat dependencies.txt | grep "org.springframework.ai"

# Windows
type dependencies.txt | findstr "org.springframework.ai"
```

### 方法 B：使用 Maven 分析依赖树

1. **创建临时 `pom.xml`**：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.example</groupId>
    <artifactId>temp-dependency-analyzer</artifactId>
    <version>1.0.0</version>
    
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
    </properties>
    
    <repositories>
        <repository>
            <id>spring-milestone</id>
            <url>https://repo.spring.io/milestone</url>
        </repository>
    </repositories>
    
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
            <version>1.0.0-M4</version>
        </dependency>
    </dependencies>
</project>
```

2. **生成依赖树**：

```bash
mvn dependency:tree > dependencies.txt
```

3. **查看依赖树**：

```bash
cat dependencies.txt
```

### 方法 C：手动下载传递依赖（如果无法使用 Gradle/Maven）

根据 Spring AI 的常见依赖，主要需要下载以下依赖：

1. **spring-ai-core**
2. **spring-ai-openai**
3. **spring-boot-starter**（通常已在 Maven Central）
4. 其他 Spring 相关依赖

**下载脚本示例**（需要根据实际依赖树调整）：

```bash
#!/bin/bash
BASE_URL="https://repo.spring.io/milestone"
GROUP_ID="org.springframework.ai"

# 定义需要下载的依赖列表
declare -a ARTIFACTS=(
    "spring-ai-core:1.0.0-M4"
    "spring-ai-openai:1.0.0-M4"
    # 添加其他依赖...
)

for artifact in "${ARTIFACTS[@]}"; do
    IFS=':' read -r artifact_id version <<< "$artifact"
    path="${GROUP_ID//./\/}/${artifact_id}/${version}"
    
    echo "下载 ${artifact_id}:${version}"
    mkdir -p "spring-ai-dependencies/${artifact_id}"
    
    curl -L -o "spring-ai-dependencies/${artifact_id}/${artifact_id}-${version}.pom" \
        "${BASE_URL}/${path}/${artifact_id}-${version}.pom"
    
    curl -L -o "spring-ai-dependencies/${artifact_id}/${artifact_id}-${version}.jar" \
        "${BASE_URL}/${path}/${artifact_id}-${version}.jar"
done
```

## 步骤 3：安装依赖到本地 Maven 仓库

### 安装主依赖

**Windows (PowerShell)**：
```powershell
cd spring-ai-dependencies

mvn install:install-file `
  -Dfile=spring-ai-openai-spring-boot-starter-1.0.0-M4.jar `
  -DgroupId=org.springframework.ai `
  -DartifactId=spring-ai-openai-spring-boot-starter `
  -Dversion=1.0.0-M4 `
  -Dpackaging=jar `
  -DpomFile=spring-ai-openai-spring-boot-starter-1.0.0-M4.pom
```

**Linux/Mac**：
```bash
cd spring-ai-dependencies

mvn install:install-file \
  -Dfile=spring-ai-openai-spring-boot-starter-1.0.0-M4.jar \
  -DgroupId=org.springframework.ai \
  -DartifactId=spring-ai-openai-spring-boot-starter \
  -Dversion=1.0.0-M4 \
  -Dpackaging=jar \
  -DpomFile=spring-ai-openai-spring-boot-starter-1.0.0-M4.pom
```

### 批量安装所有依赖

如果下载了多个依赖，可以使用脚本批量安装：

**Windows (PowerShell 脚本)**：

```powershell
# install-dependencies.ps1
$dependenciesDir = "spring-ai-dependencies"

Get-ChildItem -Path $dependenciesDir -Recurse -Filter "*.jar" | ForEach-Object {
    $jarFile = $_.FullName
    $pomFile = $jarFile -replace '\.jar$', '.pom'
    
    if (Test-Path $pomFile) {
        $fileName = $_.BaseName
        # 从文件名解析 artifactId 和 version
        # 格式：artifactId-version.jar
        if ($fileName -match '^(.+)-(\d+\.\d+\.\d+-M\d+)$') {
            $artifactId = $matches[1]
            $version = $matches[2]
            
            Write-Host "安装 $artifactId:$version" -ForegroundColor Green
            
            mvn install:install-file `
              -Dfile=$jarFile `
              -DgroupId=org.springframework.ai `
              -DartifactId=$artifactId `
              -Dversion=$version `
              -Dpackaging=jar `
              -DpomFile=$pomFile `
              -DgeneratePom=false
        }
    }
}
```

**Linux/Mac (Bash 脚本)**：

```bash
#!/bin/bash
# install-dependencies.sh

DEPENDENCIES_DIR="spring-ai-dependencies"

find "$DEPENDENCIES_DIR" -name "*.jar" | while read jar_file; do
    pom_file="${jar_file%.jar}.pom"
    
    if [ -f "$pom_file" ]; then
        filename=$(basename "$jar_file" .jar)
        # 从文件名解析 artifactId 和 version
        # 格式：artifactId-version.jar
        if [[ $filename =~ ^(.+)-([0-9]+\.[0-9]+\.[0-9]+-M[0-9]+)$ ]]; then
            artifact_id="${BASH_REMATCH[1]}"
            version="${BASH_REMATCH[2]}"
            
            echo "安装 $artifact_id:$version"
            
            mvn install:install-file \
              -Dfile="$jar_file" \
              -DgroupId=org.springframework.ai \
              -DartifactId="$artifact_id" \
              -Dversion="$version" \
              -Dpackaging=jar \
              -DpomFile="$pom_file" \
              -DgeneratePom=false
        fi
    fi
done
```

## 步骤 4：验证安装

### 检查本地 Maven 仓库

本地 Maven 仓库通常位于：
- **Windows**: `C:\Users\<用户名>\.m2\repository\`
- **Linux/Mac**: `~/.m2/repository/`

检查文件是否存在：

```bash
# Windows
dir C:\Users\%USERNAME%\.m2\repository\org\springframework\ai\spring-ai-openai-spring-boot-starter\1.0.0-M4

# Linux/Mac
ls -la ~/.m2/repository/org/springframework/ai/spring-ai-openai-spring-boot-starter/1.0.0-M4
```

应该看到：
- `spring-ai-openai-spring-boot-starter-1.0.0-M4.jar`
- `spring-ai-openai-spring-boot-starter-1.0.0-M4.pom`

### 使用 Gradle 验证

在项目目录中运行：

```bash
./gradlew dependencies --configuration runtimeClasspath | grep "spring-ai-openai-spring-boot-starter"
```

如果看到依赖被正确解析，说明安装成功。

### 尝试构建项目

```bash
./gradlew clean build
```

如果构建成功，说明所有依赖都已正确安装。

## 步骤 5：处理传递依赖问题

如果构建时仍然提示缺少某些依赖，需要：

1. **查看错误信息**，找出缺失的依赖
2. **从 Spring Milestone 仓库下载**缺失的依赖
3. **安装到本地仓库**

**快速下载脚本**（根据错误信息调整）：

```bash
# 示例：下载 spring-ai-core
GROUP_ID="org.springframework.ai"
ARTIFACT_ID="spring-ai-core"
VERSION="1.0.0-M4"
BASE_URL="https://repo.spring.io/milestone"

PATH_PART="${GROUP_ID//./\/}"
POM_URL="${BASE_URL}/${PATH_PART}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.pom"
JAR_URL="${BASE_URL}/${PATH_PART}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.jar"

# 下载
curl -L -o "${ARTIFACT_ID}-${VERSION}.pom" "$POM_URL"
curl -L -o "${ARTIFACT_ID}-${VERSION}.jar" "$JAR_URL"

# 安装
mvn install:install-file \
  -Dfile="${ARTIFACT_ID}-${VERSION}.jar" \
  -DgroupId="$GROUP_ID" \
  -DartifactId="$ARTIFACT_ID" \
  -Dversion="$VERSION" \
  -Dpackaging=jar \
  -DpomFile="${ARTIFACT_ID}-${VERSION}.pom"
```

## 完整工作流程示例

### 场景：在有外网的机器上下载，然后传输到内网

1. **在有外网的机器上**：

```bash
# 1. 下载主依赖
./scripts/download-spring-ai-dependencies.sh

# 2. 使用 Gradle 分析依赖树
./gradlew dependencies --configuration runtimeClasspath > dependencies.txt

# 3. 根据依赖树下载所有传递依赖（手动或使用脚本）

# 4. 打包所有依赖
tar -czf spring-ai-dependencies.tar.gz spring-ai-dependencies/
```

2. **传输到内网机器**：

```bash
# 使用 U盘、内网传输工具等方式
```

3. **在内网机器上**：

```bash
# 1. 解压
tar -xzf spring-ai-dependencies.tar.gz

# 2. 安装所有依赖
./scripts/install-dependencies.sh  # 或使用上面提供的脚本

# 3. 验证
./gradlew clean build
```

## 常见问题

### Q1: Maven 安装失败，提示找不到 POM 文件

**解决方案**：确保 POM 文件和 JAR 文件在同一目录，且文件名匹配。

### Q2: 构建时仍然提示缺少依赖

**解决方案**：
1. 检查依赖树，确认所有传递依赖都已下载
2. 某些依赖可能在 Maven Central，确保可以访问 Maven Central
3. 检查依赖版本是否匹配

### Q3: 如何知道需要下载哪些传递依赖？

**解决方案**：
1. 使用 `./gradlew dependencies` 生成完整的依赖树
2. 查看错误信息，逐个下载缺失的依赖
3. 参考 Spring AI 官方文档了解依赖关系

### Q4: 本地仓库路径是什么？

**解决方案**：
- 默认路径：`~/.m2/repository/` (Linux/Mac) 或 `C:\Users\<用户名>\.m2\repository\` (Windows)
- 可以通过 `mvn help:evaluate -Dexpression=settings.localRepository` 查看

## 参考资源

- Spring AI 官方文档：https://spring.io/projects/spring-ai
- Spring Milestone 仓库：https://repo.spring.io/milestone
- Maven 安装文件命令文档：https://maven.apache.org/guides/mini/guide-3rd-party-jars-local.html





